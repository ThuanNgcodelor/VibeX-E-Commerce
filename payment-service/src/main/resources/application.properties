spring.application.name=payment-service
server.port=6007

spring.config.import=optional:configserver:${SPRING_CLOUD_CONFIG_URI:http://localhost:8888/}
# ============================================
# VNPAY CONFIGURATION
# ============================================
vnpay.tmn-code=OCFVVWW0
vnpay.hash-secret=4QW5KB2ZPGEME35K90BTZP2QFM7UWNRT
vnpay.pay-url=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
vnpay.api-url=https://sandbox.vnpayment.vn/merchant_webapi/api/transaction
vnpay.return-url=${VNPAY_RETURN_URL:http://localhost/payment/vnpay/return}

# MOMO CONFIGURATION
momo.partner-code=MOMO
momo.access-key=F8BBA842ECF85
momo.secret-key=K951B6PE1waDMi640xX08PD3vg6EkVlz
momo.api-url=https://test-payment.momo.vn/v2/gateway/api/create
momo.return-url=${MOMO_RETURN_URL:http://localhost/payment/momo/return}
momo.ipn-url=${MOMO_IPN_URL:http://localhost/v1/payment/momo/ipn}

# ============================================
# DISCOVERY & CONFIG SERVER
# ============================================
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
eureka.instance.prefer-ip-address=true

# ============================================
# KAFKA CONFIGURATION
# ============================================
spring.kafka.producer.bootstrap-servers=${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
spring.kafka.consumer.bootstrap-servers=${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

## Producer configuration
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer

## Consumer configuration (Bổ sung để tránh lỗi khi Payment nhận event)
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
spring.kafka.consumer.properties.spring.json.trusted.packages=*

# Kafka Topic Names
kafka.topic.payment=payment-topic
# Consumer Group ID
spring.kafka.consumer.group-id=payment-service-group

# ============================================
# Database Connection Pool (HikariCP)
# ============================================
# Số lượng kết nối tối đa trong pool
# Giá trị 25 phù hợp với service xử lý thanh toán (gọi API bên ngoài, thao tác DB)
spring.datasource.hikari.maximum-pool-size=25

# Số lượng kết nối tối thiểu luôn giữ sẵn
# Giữ 5 connections sẵn để tránh delay khi có request mới
spring.datasource.hikari.minimum-idle=5

# Thời gian chờ kết nối từ pool (30 giây)
# Nếu không có connection available trong 30 giây -> throw exception
spring.datasource.hikari.connection-timeout=30000

# Thời gian chờ cho kết nối rỗng (10 phút)
# Tự động đóng connections không được sử dụng sau 10 phút
spring.datasource.hikari.idle-timeout=600000

# Tuổi thọ tối đa của connection (30 phút)
# Đóng connection sau 30 phút dù đang được sử dụng để tránh lỗi "treo" kết nối
spring.datasource.hikari.max-lifetime=1800000

# Ngưỡng phát hiện rò rỉ kết nối (1 phút)
# Cảnh báo nếu connection không được đóng sau 1 phút
spring.datasource.hikari.leak-detection-threshold=60000

# Câu lệnh kiểm tra kết nối còn sống
spring.datasource.hikari.connection-test-query=SELECT 1

# Tên pool để dễ debug trong logs
spring.datasource.hikari.pool-name=PaymentServiceHikariPool

# ============================================
# Tomcat Thread Pool (Medium Traffic)
# ============================================
# Số lượng threads tối đa xử lý HTTP requests
# 200 threads phù hợp với payment service có traffic trung bình
server.tomcat.threads.max=200

# Số lượng threads giữ sẵn
# Giữ 20 threads sẵn để xử lý requests ngay lập tức
server.tomcat.threads.min-spare=20

# Số lượng connections chờ trong hàng đợi (Queue)
# Khi 200 threads đều bận, 500 connections tiếp theo sẽ chờ trong queue
server.tomcat.accept-count=500

# Tổng số connections TCP tối đa server có thể nhận
server.tomcat.max-connections=5000

# Thời gian chờ của connection (20 giây)
server.tomcat.connection-timeout=20000

# Enable compression - Nén response để giảm băng thông
server.compression.enabled=true
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
server.compression.min-response-size=1024

# ============================================
# Async Processing
# ============================================
# Enable async support - Xử lý requests không đồng bộ
spring.web.async.request-timeout=30000
spring.web.async.timeout=30000

# Thread pool cho async tasks (riêng biệt với Tomcat threads)
spring.task.execution.pool.core-size=20
spring.task.execution.pool.max-size=50
spring.task.execution.pool.queue-capacity=500
spring.task.execution.thread-name-prefix=async-task-

# ============================================
# JPA Batch Processing
# ============================================
# Batch size để tối ưu inserts/updates vào Database
spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true

# Tắt log SQL trong production để giảm tải
spring.jpa.show-sql=false

# Kiểm tra connection trước khi dùng (Validation)
spring.datasource.hikari.validation-timeout=3000

# ============================================
# Spring Boot Actuator (Monitoring)
# ============================================
# Expose các endpoints của Actuator
management.endpoints.web.exposure.include=health,metrics,info,prometheus

# Hiển thị chi tiết health check
management.endpoint.health.show-details=always

# Tag tên ứng dụng cho metrics
management.metrics.tags.application=${spring.application.name}