spring.application.name=payment-service
server.port=8006

# VNPay
vnpay.tmn-code=OCFVVWW0
vnpay.hash-secret=4QW5KB2ZPGEME35K90BTZP2QFM7UWNRT
vnpay.pay-url=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
vnpay.api-url=https://sandbox.vnpayment.vn/merchant_webapi/api/transaction
vnpay.return-url=http://localhost:5173/payment/vnpay/return

spring.config.import=configserver:http://localhost:8888/
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
eureka.instance.prefer-ip-address=true

# Kafka Producer Configuration
spring.kafka.producer.bootstrap-servers=localhost:9092
spring.kafka.consumer.bootstrap-servers=localhost:9092
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer

# Kafka Topic Names
kafka.topic.payment=payment-topic

# ============================================
# ✅ TỐI ƯU: Database Connection Pool (HikariCP)
# ============================================
# Maximum số connections trong pool - Payment Service có traffic trung bình
# Giá trị 25 phù hợp với service xử lý payments (external API calls, database operations)
spring.datasource.hikari.maximum-pool-size=25

# Minimum số idle connections luôn giữ sẵn trong pool
# Giữ 5 connections sẵn để tránh delay khi có request mới
spring.datasource.hikari.minimum-idle=5

# Timeout khi chờ connection từ pool (milliseconds)
# Nếu không có connection available trong 30 giây → throw exception
spring.datasource.hikari.connection-timeout=30000

# Timeout cho idle connections (milliseconds = 10 phút)
# Tự động đóng connections không được sử dụng sau 10 phút để giải phóng tài nguyên
spring.datasource.hikari.idle-timeout=600000

# Maximum lifetime của connection (milliseconds = 30 phút)
# Đóng connection sau 30 phút dù đang được sử dụng để tránh stale connections
spring.datasource.hikari.max-lifetime=1800000

# Phát hiện connection leak (milliseconds = 1 phút)
# Cảnh báo nếu connection không được đóng sau 1 phút (có thể do code quên close)
spring.datasource.hikari.leak-detection-threshold=60000

# Connection test query - Kiểm tra connection còn sống trước khi sử dụng
# SELECT 1 là query đơn giản nhất, nhanh nhất để test connection
spring.datasource.hikari.connection-test-query=SELECT 1

# Pool name - Tên pool để dễ debug và monitor trong logs
spring.datasource.hikari.pool-name=PaymentServiceHikariPool

# ============================================
# ✅ TỐI ƯU: Tomcat Thread Pool (Medium Traffic Service)
# ============================================
# Maximum số threads xử lý HTTP requests đồng thời
# 200 threads cho phép xử lý 200 requests cùng lúc (phù hợp với payment service có traffic trung bình)
server.tomcat.threads.max=200

# Minimum số threads giữ sẵn (luôn có sẵn, không cần tạo mới)
# Giữ 20 threads sẵn để xử lý requests ngay lập tức, tránh delay
server.tomcat.threads.min-spare=20

# Maximum số connections chờ trong queue (khi tất cả threads đang busy)
# Khi 200 threads đều đang xử lý, 500 connections tiếp theo sẽ chờ trong queue
server.tomcat.accept-count=500

# Maximum số connections TCP (tổng số connections server có thể nhận)
# 5000 connections cho phép server chịu tải trung bình
server.tomcat.max-connections=5000

# Connection timeout (milliseconds = 20 giây)
# Đóng connection nếu không có request trong 20 giây để giải phóng tài nguyên
server.tomcat.connection-timeout=20000

# Enable compression - Nén response để giảm bandwidth
# Giảm kích thước response (JSON, HTML, CSS, JS) → tăng tốc độ load
server.compression.enabled=true

# Các MIME types sẽ được nén
# Nén text/html, JSON, CSS, JS để giảm kích thước response
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json

# Minimum response size để nén (bytes)
# Chỉ nén response >= 1KB (1024 bytes), vì nén response nhỏ không hiệu quả
server.compression.min-response-size=1024

# ============================================
# ✅ TỐI ƯU: Async Processing
# ============================================
# Enable async support - Xử lý requests không đồng bộ
# Giảm blocking threads → tăng throughput mà không cần thêm threads
spring.web.async.request-timeout=30000
spring.web.async.timeout=30000

# Thread pool cho async tasks (riêng biệt với Tomcat threads)
spring.task.execution.pool.core-size=20
spring.task.execution.pool.max-size=50
spring.task.execution.pool.queue-capacity=500
spring.task.execution.thread-name-prefix=async-task-

# ============================================
# ✅ TỐI ƯU: JPA Batch Processing
# ============================================
# Batch size để tối ưu inserts/updates
spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true

# Disable show-sql trong production (giảm overhead)
spring.jpa.show-sql=false

# Connection pool validation
spring.datasource.hikari.validation-timeout=3000

# ============================================
# ✅ TỐI ƯU: Spring Boot Actuator (Monitoring)
# ============================================
# Expose các endpoints của Actuator để monitor service
# health: Kiểm tra service còn sống không
# metrics: Xem các metrics (CPU, memory, requests, etc.)
# info: Thông tin về service
# prometheus: Export metrics theo format Prometheus (để tích hợp với Grafana)
management.endpoints.web.exposure.include=health,metrics,info,prometheus

# Hiển thị chi tiết health check (database, disk, etc.)
# Always: Luôn hiển thị chi tiết (có thể dùng "when-authorized" để bảo mật hơn)
management.endpoint.health.show-details=always

# Enable Prometheus metrics export
# Cho phép Prometheus scrape metrics từ endpoint /actuator/prometheus

# Tag application name cho metrics
# Giúp phân biệt metrics của các services khác nhau trong Prometheus/Grafana
management.metrics.tags.application=${spring.application.name}
