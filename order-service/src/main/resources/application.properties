spring.application.name=order-service
server.port=6005
#spring.config.import=optional:configserver:http://localhost:8888/
spring.config.import=optional:configserver:http://localhost:8888/
#spring.config.import=configserver:http://localhost:8888/

# ============================================
# KAFKA CONFIGURATION
# ============================================
spring.kafka.producer.bootstrap-servers=localhost:9092
# ??a ch? Kafka broker m� producer s? k?t n?i

## Producer configuration
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
# Serializer d�ng ?? chuy?n ??i Key c?a message th�nh m?ng byte
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer
# Serializer d�ng ?? chuy?n ??i Value c?a message th�nh JSON

## Kafka Consumer configuration
spring.kafka.consumer.bootstrap-servers=localhost:9092
# ??a ch? Kafka broker m� consumer k?t n?i
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer

# Cho ph�p deserializer tin t??ng t?t c? c�c package
spring.kafka.consumer.properties.spring.json.trusted.packages=*

# --- FIX L?I DESERIALIZE KH�C PACKAGE ---
# �p ki?u d? li?u v? DTO local thay v� d�ng th�ng tin type header t? Producer
# (R?t quan tr?ng khi Payment Service g?i event nh?ng Order Service l?i d�ng DTO kh�c package)
spring.kafka.consumer.properties.spring.json.value.default.type=com.example.orderservice.dto.PaymentEvent
spring.kafka.consumer.properties.spring.json.use.type.headers=false

## Topic names (Bi?n t�y ch?nh d�ng trong code)
kafka.topic.order=order-topic
kafka.topic.notification=notification-topic
kafka.topic.payment=payment-topic
kafka.topic.updatestatusorder=update-order-topic
# Phase 3: Async Stock Decrease
kafka.topic.stock-decrease=stock-decrease-topic
kafka.topic.order-compensation=order-compensation-topic

## Consumer group
spring.kafka.consumer.group-id=order-service-group

# ============================================
# SWAGGER & CONFIG SERVER
# ============================================
springdoc.swagger-ui.path=/swagger-ui.html

# ============================================
# GHN API Configuration (Giao H�ng Nhanh)
# ============================================
ghn.api.url=https://dev-online-gateway.ghn.vn/shiip/public-api
ghn.api.token=57404b9d-d3e9-11f0-a3d6-dac90fb956b5
ghn.shop.id=198371

# ============================================
# Database Connection Pool (HikariCP)
# ============================================
# Maximum s? connections trong pool - Order Service c?n nhi?u connections v� x? l� nhi?u orders
# Gi� tr? 30 ph� h?p v?i service c� traffic cao, x? l� nhi?u database operations
spring.datasource.hikari.maximum-pool-size=60

# Minimum s? idle connections lu�n gi? s?n trong pool
# Gi? 10 connections s?n ?? tr�nh delay khi c� request m?i
spring.datasource.hikari.minimum-idle=10

# Timeout khi ch? connection t? pool (milliseconds)
# N?u kh�ng c� connection available trong 30 gi�y -> throw exception
spring.datasource.hikari.connection-timeout=30000

# Timeout cho idle connections (milliseconds = 10 ph�t)
# T? ??ng ?�ng connections kh�ng ???c s? d?ng sau 10 ph�t ?? gi?i ph�ng t�i nguy�n
spring.datasource.hikari.idle-timeout=600000

# Maximum lifetime c?a connection (milliseconds = 30 ph�t)
# ?�ng connection sau 30 ph�t d� ?ang ???c s? d?ng ?? tr�nh stale connections
spring.datasource.hikari.max-lifetime=1800000

# Ph�t hi?n connection leak (milliseconds = 1 ph�t)
# C?nh b�o n?u connection kh�ng ???c ?�ng sau 1 ph�t (c� th? do code qu�n close)
spring.datasource.hikari.leak-detection-threshold=60000

# Connection test query - Ki?m tra connection c�n s?ng tr??c khi s? d?ng
# SELECT 1 l� query ??n gi?n nh?t, nhanh nh?t ?? test connection
spring.datasource.hikari.connection-test-query=SELECT 1

# Pool name - T�n pool ?? d? debug v� monitor trong logs
spring.datasource.hikari.pool-name=OrderServiceHikariPool

# ============================================
# Tomcat Thread Pool (High Traffic Service)
# ============================================
# Maximum s? threads x? l� HTTP requests ??ng th?i
# 500 threads cho ph�p x? l� 500 requests c�ng l�c (ph� h?p v?i order service c� traffic cao)
server.tomcat.threads.max=500

# Minimum s? threads gi? s?n (lu�n c� s?n, kh�ng c?n t?o m?i)
# Gi? 50 threads s?n ?? x? l� requests ngay l?p t?c, tr�nh delay
server.tomcat.threads.min-spare=50

# Maximum s? connections ch? trong queue (khi t?t c? threads ?ang busy)
# Khi 500 threads ??u ?ang x? l�, 1000 connections ti?p theo s? ch? trong queue
server.tomcat.accept-count=1000

# Maximum s? connections TCP (t?ng s? connections server c� th? nh?n)
# 10000 connections cho ph�p server ch?u t?i cao, ph� h?p v?i microservice c� nhi?u clients
server.tomcat.max-connections=10000

# Connection timeout (milliseconds = 20 gi�y)
# ?�ng connection n?u kh�ng c� request trong 20 gi�y ?? gi?i ph�ng t�i nguy�n
server.tomcat.connection-timeout=20000

# Enable compression - N�n response ?? gi?m bandwidth
# Gi?m k�ch th??c response (JSON, HTML, CSS, JS) -> t?ng t?c ?? load
server.compression.enabled=true

# C�c MIME types s? ???c n�n
# N�n text/html, JSON, CSS, JS ?? gi?m k�ch th??c response
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json

# Minimum response size ?? n�n (bytes)
# Ch? n�n response >= 1KB (1024 bytes), v� n�n response nh? kh�ng hi?u qu?
server.compression.min-response-size=1024

# ============================================
# Spring Boot Actuator (Monitoring)
# ============================================
# Expose c�c endpoints c?a Actuator ?? monitor service
# health: Ki?m tra service c�n s?ng kh�ng
# metrics: Xem c�c metrics (CPU, memory, requests, etc.)
# info: Th�ng tin v? service
# prometheus: Export metrics theo format Prometheus (?? t�ch h?p v?i Grafana)
management.endpoints.web.exposure.include=health,metrics,info,prometheus

# Hi?n th? chi ti?t health check (database, disk, etc.)
management.endpoint.health.show-details=always

# Tag application name cho metrics
# Gi�p ph�n bi?t metrics c?a c�c services kh�c nhau trong Prometheus/Grafana
management.metrics.tags.application=${spring.application.name}

# ============================================
# Hibernate Batch Processing (Performance Optimization)
# ============================================
# Batch size: Number of statements to batch before executing
# 50 is optimal for most cases - balances between memory and performance
spring.jpa.properties.hibernate.jdbc.batch_size=50

# Order inserts: Group INSERT statements together
# Reduces DB round-trips from N inserts to ~1-2 batch operations
spring.jpa.properties.hibernate.order_inserts=true

# Order updates: Group UPDATE statements together
# Same benefit as order_inserts but for UPDATEs
spring.jpa.properties.hibernate.order_updates=true

# Batch versioned data: Allow batching for entities with @Version
# Important for entities with optimistic locking
spring.jpa.properties.hibernate.batch_versioned_data=true

# Optional: Enable for debugging batch operations
spring.jpa.properties.hibernate.show_sql=false
spring.jpa.properties.hibernate.format_sql=false
logging.level.org.hibernate.SQL=INFO
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# ============================================
# Async Executor Configuration (Cart Cleanup)
# ============================================
# Core pool size: Number of threads to keep alive
# 10 threads for async cart cleanup operations
spring.task.execution.pool.core-size=10

# Max pool size: Maximum number of threads
# Can scale up to 20 threads during high load
spring.task.execution.pool.max-size=20

# Queue capacity: Number of tasks to queue when all threads are busy
# 100 tasks can wait in queue before rejection
spring.task.execution.pool.queue-capacity=100

# Thread name prefix for easier debugging
spring.task.execution.thread-name-prefix=async-cart-
